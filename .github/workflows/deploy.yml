- name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Navigate to project directory or clone if it doesn't exist
            cd ~/whatssuite || git clone git@github.com:pushpraj-rmx/whatssuite.git ~/whatssuite && cd ~/whatssuite
            
            # Pull the latest code
            git pull origin main
            
            # Safely write the secret to the .env file
            cat <<'EOF' > .env
            ${{ secrets.ENV_FILE_PRODUCTION }}
            EOF
            
            # Build and run the containers
            docker-compose up --build -d
            
            # Clean up old docker images
            docker image prune -f