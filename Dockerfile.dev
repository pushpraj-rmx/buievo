# Development Dockerfile for buievo
FROM node:20-alpine AS base

# Install pnpm
RUN npm install -g pnpm

# Set working directory
WORKDIR /usr/src/app

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy all source code
COPY . .

# Install all dependencies (including dev dependencies)
RUN pnpm install --frozen-lockfile

# Generate Prisma client
RUN ["pnpm", "--filter", "@buievo/db", "exec", "prisma", "generate"]

# Build packages (but not apps for development)
RUN pnpm --filter "./packages/*" build

# API Development Stage
FROM base AS api-dev
WORKDIR /usr/src/app
EXPOSE 3001
CMD ["pnpm", "--filter", "@buievo/api", "dev"]

# Wapp-Service Development Stage
FROM base AS wapp-service-dev
WORKDIR /usr/src/app
CMD ["pnpm", "--filter", "@buievo/wapp-service", "dev"]

# Admin Development Stage
FROM base AS admin-dev
WORKDIR /usr/src/app
EXPOSE 3002
CMD ["pnpm", "--filter", "@buievo/admin", "dev", "--port", "3002"]

# Web Development Stage
FROM base AS web-dev
WORKDIR /usr/src/app
EXPOSE 3000
CMD ["pnpm", "--filter", "@buievo/web", "dev", "--port", "3000"]
